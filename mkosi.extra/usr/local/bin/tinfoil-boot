#!/bin/bash
# This script is executed as root by systemd on boot

set -ex

function get_cmdline_param() {
    cat /proc/cmdline | grep -oP "(?<=$1=)[^ ]*"
}

if [ "$(get_cmdline_param "tinfoil-debug")" != "on" ]; then
    echo "Disabling serial tty"
    systemctl stop serial-getty@ttyS0
else
    echo "WARNING: Debug mode is enabled"
fi

echo "Creating ramdisk..."
RAM_GB=$(($(free -g | awk '/^Mem:/{print $2}')))
SIZE=$((RAM_GB - 16))

# Fallback for dev machines
if [ $SIZE -lt 16 ]; then
    SIZE=1
fi

mount -t tmpfs -o size=${SIZE}G tmpfs /mnt/ramdisk
chmod 777 /mnt/ramdisk

cd /mnt/ramdisk

echo "Loading nvidia driver..."
/sbin/modprobe ecdsa_generic ecdh
/sbin/modprobe --ignore-install nvidia

# Verify GPU attestation
echo "Verifying GPU attestation..."
source /opt/venv/bin/activate
python3 -m verifier.cc_admin
#nvidia-smi conf-compute -srs 1

# Restart ollama with GPU ready state enabled
sleep 2
systemctl restart ollama

echo Waiting for ollama service to start...
while ! $(curl -sL http://localhost:11434/api/version > /dev/null 2>&1); do
    echo "Waiting"
    sleep 1
done

TARGET_IMAGE=$(get_cmdline_param "tinfoil-model")

echo Pulling image...
ollama pull $TARGET_IMAGE
