#!/bin/bash
# This script is executed as root by systemd on boot

set -ex

function get_cmdline_param() {
    local param=$1
    local value=$(cat /proc/cmdline | grep -oP "(?<=${param}=)[^ ]*")
    echo $value
}

echo "Loading nvidia driver..."
/sbin/modprobe ecdsa_generic ecdh
/sbin/modprobe --ignore-install nvidia

# TODO: Verify attestation
echo "Enabling GPU..."
nvidia-smi conf-compute -srs 1

echo "Creating ramdisk..."
RAM_GB=$(($(free -g | awk '/^Mem:/{print $2}')))
SIZE=$((RAM_GB - 16))
rm -rf /mnt/ramdisk || true
mkdir -p /mnt/ramdisk
mount -t tmpfs -o size=${SIZE}G tmpfs /mnt/ramdisk
chmod 777 /mnt/ramdisk

echo Creating ollama user...
useradd -r -s /bin/false -U -m -d /usr/share/ollama ollama

echo Starting ollama service...
systemctl daemon-reload
systemctl start ollama

export OLLAMA_HOST=127.0.0.1:8080

echo Waiting for ollama service to start...
while ! $(curl -sL http://localhost:11434/api/version > /dev/null 2>&1); do
    echo "Waiting"
    sleep 1
done

TARGET_IMAGE=$(get_cmdline_param "tinfoil-model")

echo Pulling image...
ollama pull $TARGET_IMAGE
